name: nix-proto-gen
on:
  push:
    branches:
      - master
  pull_request:
    branches:
      - master
  workflow_dispatch:

jobs:
  build-packages:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        version: [23.11]
    steps:
        - uses: cachix/install-nix-action@v23
        - name: Get branch names
          id: branch-name
          uses: tj-actions/branch-names@v7
        - uses: actions/checkout@v4
          with:
            repository: RCMast3r/data_acq
            ref: refs/heads/master
        
        - name: Get current date and time
          id: date
          run: echo "::set-output name=date::$(date +'%Y-%m-%dT%H:%M:%S')"

        - name: release
          uses: actions/create-release@v1
          
          id: create_release
          with:
            draft: false
            prerelease: false
            release_name: ${{ steps.date.outputs.date }}
            tag_name: ${{ steps.date.outputs.date }}
            repo: hytech_dbc_proto
          env:
            GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

        - name: Upload dbc_file.dbc
          run: |
            curl -X POST \
                -H "Authorization: token ${{ secrets.GH_TOKEN }}" \
                -H "Content-Type: application/octet-stream" \
                --data-binary hytech.dbc \
                "$UPLOAD_URL?name=hytech.dbc"

        # Step to upload hytech.proto
        - name: Upload hytech.proto
          run: |
            curl -X POST \
                -H "Authorization: token $GITHUB_TOKEN" \
                -H "Content-Type: application/octet-stream" \
                --data-binary @hytech.proto \
                "$UPLOAD_URL?name=hytech.proto" 